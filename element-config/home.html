<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Matrix Mesh Status</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size: 1.4rem; }
    .server { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; margin: 0.5rem 0; border-radius: 6px; background: #f5f5f5; }
    .status { width: 12px; height: 12px; border-radius: 50%; }
    .online { background: #4caf50; }
    .offline { background: #ccc; }
    .checking { background: #ff9800; }
    .server-name { font-weight: 600; }
    .server-url { color: #666; font-size: 0.85rem; }
    .self { border-left: 3px solid #4caf50; }
  </style>
</head>
<body>
  <h1>Mesh Nodes</h1>
  <div id="servers"></div>
  <script>
    async function checkServer(url) {
      try {
        const resp = await fetch(url + '/_matrix/client/versions', { mode: 'cors', signal: AbortSignal.timeout(5000) });
        return resp.ok;
      } catch {
        return false;
      }
    }

    async function fetchJson(url) {
      const resp = await fetch(url, { signal: AbortSignal.timeout(5000) });
      return resp.json();
    }

    function addServerNode(container, server, isSelf) {
      const div = document.createElement('div');
      div.className = 'server' + (isSelf ? ' self' : '');
      const id = 'status-' + server.name.replace(/\W/g, '-');
      div.innerHTML = `
        <div class="status checking" id="${id}"></div>
        <div>
          <div class="server-name">${server.name}${isSelf ? ' (you)' : ''}</div>
          <div class="server-url">${server.url}</div>
        </div>
      `;
      container.appendChild(div);

      checkServer(server.url).then(online => {
        const dot = document.getElementById(id);
        dot.className = 'status ' + (online ? 'online' : 'offline');
      });
    }

    async function loadServers() {
      const container = document.getElementById('servers');

      // Load self
      let self;
      try {
        self = await fetchJson('server.json');
        addServerNode(container, self, true);
      } catch {
        container.textContent = 'Failed to load server.json.';
        return;
      }

      // Load peers
      let peers;
      try {
        const data = await fetchJson('peers.json');
        peers = data.peers || [];
      } catch {
        return;
      }

      // Fetch each peer's server.json
      for (const peerUrl of peers) {
        try {
          const peer = await fetchJson(peerUrl);
          addServerNode(container, peer, false);
        } catch {
          // Show unreachable peer
          const div = document.createElement('div');
          div.className = 'server';
          div.innerHTML = `
            <div class="status offline"></div>
            <div>
              <div class="server-name">Unknown</div>
              <div class="server-url">${peerUrl} (unreachable)</div>
            </div>
          `;
          container.appendChild(div);
        }
      }
    }

    loadServers();
  </script>
</body>
</html>
